# セキュリティポリシー

## サポートバージョン

このセクションでは、現在セキュリティアップデートがサポートされている freee-api-go のバージョンを説明します。

| バージョン | サポート状況 |
| ------- | ------------------ |
| 0.x.x   | :white_check_mark: |

**注意**: このプロジェクトは1.0未満の開発段階にあるため、最新リリースのみをサポートしています。1.0に到達した後、より明確な長期サポートポリシーを提供する予定です。

## 脆弱性の報告

私たちは freee-api-go のセキュリティを真剣に受け止めています。セキュリティ上の脆弱性を発見した場合は、責任ある方法で報告してください。

### 報告方法

**セキュリティ脆弱性については、公開の GitHub Issue を作成しないでください。**

代わりに、以下のいずれかの方法でセキュリティ脆弱性を報告してください：

1. **GitHub Security Advisories**（推奨）
   - https://github.com/u-masato/freee-api-go/security/advisories にアクセス
   - 「Report a vulnerability」をクリック
   - 脆弱性に関する詳細情報を提供

2. **メール**（代替手段）
   - 宛先: [セキュリティ連絡先を追加予定]
   - 件名: `[SECURITY] freee-api-go 脆弱性報告`

### 報告に含めるべき情報

可能な限り以下の情報を含めてください：

- **説明**: 脆弱性の明確な説明
- **影響**: 攻撃者がこの脆弱性で何ができるか？
- **影響バージョン**: freee-api-go のどのバージョンが影響を受けるか？
- **再現手順**: 脆弱性を再現するための詳細な手順
- **概念実証**: 可能であれば、問題を示すコードを提供
- **修正案**: 修正方法についてのアイデアがあれば共有

報告例：

```
件名: [SECURITY] ログでの OAuth2 トークン露出

説明:
デバッグログが有効な場合、OAuth2 アクセストークンが平文でログに記録されています。

影響:
アプリケーションログにアクセスできる攻撃者がユーザーのアクセストークンを盗み、
ユーザーになりすまして freee 会計データにアクセスする可能性があります。

影響バージョン:
v0.2.0 を含むそれ以前の全バージョン

再現手順:
1. デバッグログを有効にする
2. OAuth2 認証を実行
3. ログを確認 - アクセストークンが平文で表示される

概念実証:
[コードサンプルまたはログ抜粋]

修正案:
LoggingRoundTripper で機密ヘッダーをマスク（Authorization ヘッダーは
既に部分的に実装済みだが、追加のカバレッジが必要な可能性あり）
```

### 対応タイムライン

- **初期対応**: 48時間以内に報告の受領を確認します
- **状況更新**: 5営業日以内に初期評価を提供します
- **修正タイムライン**: 重大な問題については30日以内のセキュリティ修正リリースを目指します

### 期待できること

1. **確認**: 報告を受け取ったことを確認します
2. **調査**: 脆弱性を調査し、検証します
3. **修正開発**: 修正を開発し、テストします
4. **協調的開示**: 修正のリリースと公開開示を調整します
5. **クレジット**: 許可があれば、セキュリティアドバイザリであなたをクレジットします

### セキュリティアドバイザリプロセス

セキュリティ脆弱性が確認された場合：

1. GitHub でプライベートセキュリティアドバイザリを作成します
2. プライベートリポジトリフォークで修正を開発します
3. パッチ版をリリースします
4. 詳細を含むセキュリティアドバイザリを公開します
5. GitHub リリースと README でユーザーに通知します

## セキュリティベストプラクティス

freee-api-go を使用する際は、以下のセキュリティベストプラクティスに従ってください：

### 1. トークン管理

**推奨**:
- 適切なファイル権限（0600）で OAuth2 トークンを安全に保存
- 自動リフレッシュ機能を持つ組み込みの `TokenSource` を使用
- ユーザーがログアウトまたはアクセスを取り消した際にトークンを無効化
- クライアント認証情報には環境変数またはセキュアな保管庫を使用

**禁止**:
- トークンをバージョン管理にコミットしない
- 公開読み取り可能なファイルにトークンを保存しない
- 異なるユーザーやアプリケーション間でトークンを共有しない
- トークンを平文でログに記録しない

例：
```go
// 良い例: セキュアな権限でファイルベースのトークン保存を使用
tokenSource, err := auth.NewCachedTokenSource(ctx, config, token, "token.json")

// 悪い例: トークンをハードコードしない
token := &oauth2.Token{AccessToken: "hardcoded-token"} // 絶対にしないでください
```

### 2. クライアント認証情報

**推奨**:
- `client_id` と `client_secret` を環境変数またはセキュアな保管庫に保存
- 開発、ステージング、本番で異なる認証情報を使用
- 認証情報を定期的にローテーション
- OAuth2 スコープを必要最小限に制限

**禁止**:
- 認証情報をバージョン管理にコミットしない
- 本番認証情報を開発者と共有しない
- 自動テストで本番認証情報を使用しない
- 過剰な OAuth2 スコープを付与しない

例：
```go
// 良い例: 環境変数を使用
clientID := os.Getenv("FREEE_CLIENT_ID")
clientSecret := os.Getenv("FREEE_CLIENT_SECRET")

config := auth.NewConfig(
    clientID,
    clientSecret,
    redirectURL,
    []string{"read", "write"}, // 必要なスコープのみ要求
)
```

### 3. 安全な通信

**推奨**:
- 常に HTTPS エンドポイントを使用（freee API は HTTPS 必須）
- TLS 証明書を検証（Go の http.Client のデフォルト動作）
- freee-api-go の最新安定版を使用
- 依存関係を最新に保つ

**禁止**:
- TLS 証明書検証を無効にしない
- セキュリティの影響を理解せずにカスタム HTTP トランスポートを使用しない
- TLS/SSL 警告を無視しない

### 4. 入力検証

**推奨**:
- API 呼び出しに渡す前にすべてのユーザー入力を検証
- ログに表示するデータをサニタイズ
- SQL/データベース層を構築する場合はパラメータ化クエリを使用
- 悪用を防ぐためにレート制限を実装

**禁止**:
- 検証なしでユーザー入力を信頼しない
- 機密性の高いユーザーデータ（個人情報、財務データ）をログに記録しない
- エンドユーザーに詳細なエラーメッセージを公開しない

### 5. ログ記録

**推奨**:
- 機密ヘッダーをマスクする組み込みの `LoggingRoundTripper` を使用
- 不審な活動がないかログを定期的にレビュー
- ログローテーションと保持ポリシーを実装
- 異常な API 使用パターンを監視

**禁止**:
- 機密データを含む完全なリクエスト/レスポンスボディをログに記録しない
- 公開アクセス可能な場所にログを保存しない
- レビューなしでログを無期限に保持しない

`LoggingRoundTripper` は以下の機密ヘッダーを自動的にマスクします：
- `Authorization`
- `Cookie` / `Set-Cookie`
- `X-Api-Key` / `Api-Key`

### 6. エラーハンドリング

**推奨**:
- 内部の詳細を公開せずにエラーを適切に処理
- デバッグ用にコンテキストを含めてエラーをログ記録
- 一時的な障害に対して適切なリトライロジックを実装
- より良いエラー分析のために構造化されたエラー型を使用

**禁止**:
- エンドユーザーに生のエラーメッセージを返さない
- エラーを静かに無視しない
- 本番環境でスタックトレースを公開しない

例：
```go
// 良い例: コンテキストを含めてエラーを処理
deal, err := dealsService.Get(ctx, companyID, dealID)
if err != nil {
    log.Printf("取引 %d の取得に失敗: %v", dealID, err)
    return fmt.Errorf("取引の取得に失敗しました: %w", err)
}

// 悪い例: ユーザーに生のエラーを公開
deal, err := dealsService.Get(ctx, companyID, dealID)
if err != nil {
    return err // 内部のエラー詳細を公開しない
}
```

### 7. 依存関係管理

**推奨**:
- `go get -u` を使用して定期的に依存関係を更新
- 依存関係のセキュリティアドバイザリを監視
- 依存関係の整合性を確保するために `go mod verify` を使用
- 更新前に依存関係の変更をレビュー

**禁止**:
- 既知の脆弱性がある古い依存関係を使用しない
- セキュリティアップデートを無視しない
- 不要な依存関係を追加しない

定期的に実行：
```bash
# 依存関係を更新
go get -u ./...
go mod tidy

# 既知の脆弱性をチェック（govulncheck が必要）
govulncheck ./...
```

### 8. レート制限

**推奨**:
- API 制限を尊重するために組み込みの `RateLimitRoundTripper` を使用
- リトライには指数バックオフを実装
- 制限に達しないように API 使用量を監視
- レート制限エラーを適切に処理

**禁止**:
- レート制限を無視しない
- バックオフなしの積極的なリトライを実装しない
- 不必要な API 呼び出しを行わない

例：
```go
// 良い例: レート制限を設定
transport := transport.NewTransport(
    transport.WithRateLimit(10, 5),  // 10リクエスト/秒、バースト5
    transport.WithRetry(3, time.Second),
)
```

## 既知のセキュリティ考慮事項

### OAuth2 リダイレクト URI

- CSRF 攻撃を防ぐために `state` パラメータを常に検証
- 本番環境ではリダイレクト URI に HTTPS を使用
- 認可コードやトークンを URL に公開しない

### トークン保存

- トークンは 0600 権限（所有者のみ読み書き可）で保存
- トークンファイルは `.gitignore` に追加済み
- 本番環境では OS キーチェーン/認証情報マネージャの使用を検討

### 並行アクセス

- `CachedTokenSource` は並行使用に対して安全
- HTTP クライアントは並行リクエストに対して安全
- カスタムミドルウェアの共有状態に注意

## セキュリティアップデート

セキュリティアップデートを購読：

1. GitHub でこのリポジトリを **Watch**
2. freee-api-go を依存関係として使用している場合、リポジトリ設定で **セキュリティアラートを有効化**
3. セキュリティパッチについて情報を得るために **リリースをフォロー**

## セキュリティ連絡先

- **セキュリティ問題**: GitHub Security Advisories を使用（推奨）
- **一般的なセキュリティの質問**: GitHub Discussions で「security」タグを付けてディスカッションを開始

## 謝辞

脆弱性を責任ある方法で開示してくださるセキュリティ研究コミュニティの努力に感謝します。有効なセキュリティ問題を報告してくださった貢献者は、セキュリティアドバイザリで謝辞を記載します（許可がある場合）。

## 追加リソース

- [freee API セキュリティドキュメント](https://developer.freee.co.jp/)
- [OAuth 2.0 Security Best Current Practice](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics)
- [Go セキュリティポリシー](https://go.dev/security)
- [OWASP API Security Project](https://owasp.org/www-project-api-security/)

## ライセンス

このセキュリティポリシーは freee-api-go プロジェクトの一部であり、MIT ライセンスの下でライセンスされています。
